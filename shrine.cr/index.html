<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.30.1">


<link href="css/style.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="js/doc.js"></script>
<script type="text/javascript">
  CrystalDoc.base_path = "";
</script>

  <meta id="repository-name" content="github.com/jetrockets/shrine.cr">
  <title>README - github.com/jetrockets/shrine.cr</title>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="repository-links">
      <a href="index.html">README</a>
    </div>
  </div>

  <div class="search-results" class="hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="github.com/jetrockets/shrine.cr/Shrine" data-name="shrine">
      <a href="Shrine.html">Shrine</a>
      
        <ul>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/ClassMethods" data-name="shrine::classmethods">
      <a href="Shrine/ClassMethods.html">ClassMethods</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Error" data-name="shrine::error">
      <a href="Shrine/Error.html">Error</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/FileNotFound" data-name="shrine::filenotfound">
      <a href="Shrine/FileNotFound.html">FileNotFound</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/InstanceMethods" data-name="shrine::instancemethods">
      <a href="Shrine/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/InvalidFile" data-name="shrine::invalidfile">
      <a href="Shrine/InvalidFile.html">InvalidFile</a>
      
    </li>
  
  <li class="parent " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins" data-name="shrine::plugins">
      <a href="Shrine/Plugins.html">Plugins</a>
      
        <ul>
  
  <li class="parent " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins/AddMetadata" data-name="shrine::plugins::addmetadata">
      <a href="Shrine/Plugins/AddMetadata.html">AddMetadata</a>
      
        <ul>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins/AddMetadata/InstanceMethods" data-name="shrine::plugins::addmetadata::instancemethods">
      <a href="Shrine/Plugins/AddMetadata/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins/DetermineMimeType" data-name="shrine::plugins::determinemimetype">
      <a href="Shrine/Plugins/DetermineMimeType.html">DetermineMimeType</a>
      
        <ul>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins/DetermineMimeType/ClassMethods" data-name="shrine::plugins::determinemimetype::classmethods">
      <a href="Shrine/Plugins/DetermineMimeType/ClassMethods.html">ClassMethods</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins/DetermineMimeType/InstanceMethods" data-name="shrine::plugins::determinemimetype::instancemethods">
      <a href="Shrine/Plugins/DetermineMimeType/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Plugins/DetermineMimeType/MimeTypeAnalyzer" data-name="shrine::plugins::determinemimetype::mimetypeanalyzer">
      <a href="Shrine/Plugins/DetermineMimeType/MimeTypeAnalyzer.html">MimeTypeAnalyzer</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/PluginSettings" data-name="shrine::pluginsettings">
      <a href="Shrine/PluginSettings.html">PluginSettings</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Settings" data-name="shrine::settings">
      <a href="Shrine/Settings.html">Settings</a>
      
    </li>
  
  <li class="parent " data-id="github.com/jetrockets/shrine.cr/Shrine/Storage" data-name="shrine::storage">
      <a href="Shrine/Storage.html">Storage</a>
      
        <ul>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Storage/Base" data-name="shrine::storage::base">
      <a href="Shrine/Storage/Base.html">Base</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Storage/FileSystem" data-name="shrine::storage::filesystem">
      <a href="Shrine/Storage/FileSystem.html">FileSystem</a>
      
    </li>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/Storage/Memory" data-name="shrine::storage::memory">
      <a href="Shrine/Storage/Memory.html">Memory</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="github.com/jetrockets/shrine.cr/Shrine/UploadedFile" data-name="shrine::uploadedfile">
      <a href="Shrine/UploadedFile.html">UploadedFile</a>
      
        <ul>
  
  <li class=" " data-id="github.com/jetrockets/shrine.cr/Shrine/UploadedFile/MetadataType" data-name="shrine::uploadedfile::metadatatype">
      <a href="Shrine/UploadedFile/MetadataType.html">MetadataType</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<p><a href="https://travis-ci.org/jetrockets/shrine.cr" target="_blank"><img src="https://travis-ci.org/jetrockets/shrine.cr.svg?branch=master" alt="Build Status"/></a></p>

<h1>shrine.cr</h1>

<p>Shrine is a toolkit for file attachments in Crystal applications. Heavily inspired by <a href="https://shrinerb.com" target="_blank">Shrine for Ruby</a>.</p>

<h2>Documentation</h2>

<p><a href="https://jetrockets.github.io/shrine.cr" target="_blank">https://jetrockets.github.io/shrine.cr</a></p>

<h2>Installation</h2>

<ol><li>Add the dependency to your <code>shard.yml</code>:</li></ol>

<p><code></code>`yaml
   dependencies:</p>

<pre><code> shrine.cr:
   github: jetrockets<span class="s">/shrine.cr</code></pre>

<p><code></code>`</p>

<ol><li>Run <code>shards install</code></li></ol>

<h2>Usage</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;shrine.cr&quot;</span></code></pre>

<p>Shrine.cr is under heavy development!</p>

<p>First of all you should configure <code><a href="Shrine.html">Shrine</a></code>.</p>

<pre><code class="language-crystal"><span class="t">Shrine</span>.configure <span class="k">do</span> <span class="o">|</span>config<span class="o">|</span>
  config.storages[<span class="s">&quot;cache&quot;</span>] <span class="o">=</span> <span class="t">Storage</span><span class="t">::</span><span class="t">FileSystem</span>.<span class="k">new</span>(<span class="s">&quot;uploads&quot;</span>, prefix: <span class="s">&quot;cache&quot;</span>)
  config.storages[<span class="s">&quot;store&quot;</span>] <span class="o">=</span> <span class="t">Storage</span><span class="t">::</span><span class="t">FileSystem</span>.<span class="k">new</span>(<span class="s">&quot;uploads&quot;</span>)
<span class="k">end</span></code></pre>

<p>Now you can use <code><a href="Shrine.html">Shrine</a></code> directly to upload your files.</p>

<pre><code class="language-crystal"><span class="t">Shrine</span>.upload(file, <span class="n">:store</span>)</code></pre>

<p><code>Shrine.upload</code> method supports additional argument just like Shrine.rb. For example we want our file to have a custom filename.</p>

<pre><code class="language-crystal"><span class="t">Shrine</span>.upload(file, <span class="n">:store</span>, metadata: { filename: <span class="s">&quot;foo.bar&quot;</span> })</code></pre>

<h3>Custom uploaders</h3>

<p>To implement custom uploader class just inherit it from <code><a href="Shrine.html">Shrine</a></code>. You can override <code><a href="Shrine.html">Shrine</a></code> methods to implement custom logic. Here is an example how to create a custom file location.</p>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  <span class="k">def</span> <span class="m">generate_location</span>(io : <span class="t">IO</span> <span class="o">|</span> <span class="t">UploadedFile</span>, metadata, context, <span class="o">**</span>options)
    name <span class="o">=</span> <span class="k">super</span>(io, metadata, <span class="o">**</span>options)

    <span class="t">File</span>.join(<span class="s">&quot;imports&quot;</span>, context[<span class="n">:model</span>].id.to_s, name)
  <span class="k">end</span>
<span class="k">end</span>

<span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.upload(file, <span class="n">:store</span>, context: { model: <span class="t">YOUR_ORM_MODEL</span> } })</code></pre>

<h3>ORM usage example</h3>

<p>Currently ORM adapters are not implmented.</p>

<h4>Granite.</h4>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">FileImport</span> <span class="o">&lt;</span> <span class="t">Granite</span><span class="t">::</span><span class="t">Base</span>
  connection pg
  table file_imports

  column id : <span class="t">Int64</span>, primary: <span class="n">true</span>
  column asset_data : <span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span>, converter: <span class="t">Granite</span><span class="t">::</span><span class="t">Converters</span><span class="t">::</span><span class="t">Json</span>(<span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span>, <span class="t">JSON</span><span class="t">::</span><span class="t">Any</span>)

  after_save <span class="k">do</span>
    <span class="k">if</span> @asset_changed && @asset_data
      @asset_data <span class="o">=</span> <span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.store(@asset_data.not_nil!, move: <span class="n">true</span>, context: { model: <span class="k">self</span> })
      @asset_changed <span class="o">=</span> <span class="n">false</span>

      save!
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">asset</span><span class="o">=</span>(upload : <span class="t">Amber</span><span class="t">::</span><span class="t">Router</span><span class="t">::</span><span class="t">File</span>)
    @asset_data <span class="o">=</span> <span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.cache(upload.file, metadata: { filename: upload.filename })
    @asset_changed <span class="o">=</span> <span class="n">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h4>Jennifer</h4>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">FileImport</span> <span class="o">&lt;</span> <span class="t">Jennifer</span><span class="t">::</span><span class="t">Model</span><span class="t">::</span><span class="t">Base</span>
  @asset_changed : <span class="t">Bool</span> <span class="o">|</span> <span class="t">Nil</span>

  with_timestamps

  mapping(
    id: <span class="t">Primary32</span>,
    asset_data: <span class="t">JSON</span><span class="t">::</span><span class="t">Any</span>?,
    created_at: <span class="t">Time</span>?,
    updated_at: <span class="t">Time</span>?
  )

  after_save <span class="n">:move_to_store</span>

  <span class="k">def</span> <span class="m">asset</span><span class="o">=</span>(upload : <span class="t">Amber</span><span class="t">::</span><span class="t">Router</span><span class="t">::</span><span class="t">File</span>)
    <span class="k">self</span>.asset_data <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.cache(upload.file, metadata: { filename: upload.filename }).to_json)
    asset_changed! <span class="k">if</span> asset_data
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">asset</span>
    <span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span>.from_json(asset_data.not_nil!.to_json) <span class="k">if</span> asset_data
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">asset_changed?</span>
    @asset_changed || <span class="n">false</span>
  <span class="k">end</span>

  <span class="k">private</span> <span class="k">def</span> <span class="m">asset_changed!</span>
    @asset_changed <span class="o">=</span> <span class="n">true</span>
  <span class="k">end</span>

  <span class="k">private</span> <span class="k">def</span> <span class="m">move_to_store</span>
    <span class="k">if</span> asset_changed?
      <span class="k">self</span>.asset_data <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.store(asset.not_nil!, move: <span class="n">true</span>, context: { model: <span class="k">self</span> }).to_json)
      @asset_changed <span class="o">=</span> <span class="n">false</span>
      save!
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h2>Plugins</h2>

<p>Shrine.cr has a plugins interface similar to Shrine.rb. You can extend functionality of uploaders inherited from <code><a href="Shrine.html">Shrine</a></code> and also extend <code>UploadedFile</code> class.</p>

<h3>Determine MIME Type</h3>

<p>The <code>DetermineMimeType</code> plugin is used to get mime type of uploaded file in several ways.</p>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(<span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">DetermineMimeType</span>, analyzer: <span class="n">:file</span>)

  finalize_plugins!
<span class="k">end</span></code></pre>

<p><strong>Analyzers</strong></p>

<p>The following analyzers are accepted:</p>

<p>| Name            | Description                                                                                                                                                                                                         |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <code>:file</code>         | (<strong>Default</strong>). Uses the file utility to determine the MIME type from file contents. It is installed by default on most operating systems.                                                                           |
| <code>:mime</code>         | Uses the <a href="https://crystal-lang.org/api/0.31.1/MIME.html" target="_blank">MIME.from_filename</a> method to determine the MIME type from file.                                                                                               |
| <code>:content_type</code> | Retrieves the value of the <code>#content_type</code> attribute of the IO object. Note that this value normally comes from the "Content-Type" request header, so it's not guaranteed to hold the actual MIME type of the file. |</p>

<h3>Add Metadata</h3>

<p>The <code>AddMetadata</code> plugin provides a convenient method for extracting and adding custom metadata values.</p>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;base64&quot;</span>

<span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(<span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">AddMetadata</span>)

  add_metadata <span class="n">:signature</span>, -> {
    <span class="t">Base64</span>.encode(io.gets_to_end)
  }

  finalize_plugins!
<span class="k">end</span></code></pre>

<p>The above will add <code>"signature"</code> to the metadata hash.</p>

<pre><code class="language-crystal">image.metadata[<span class="s">&quot;signature&quot;</span>]</code></pre>

<p><strong>Multiple values</strong></p>

<p>You can also extract multiple metadata values at once.</p>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(<span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">AddMetadata</span>)

  add_metadata <span class="n">:multiple_values</span>, -> {
    text <span class="o">=</span> io.gets_to_end

    <span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span><span class="t">::</span><span class="t">MetadataType</span>{
      <span class="s">&quot;custom_1&quot;</span> => text,
      <span class="s">&quot;custom_2&quot;</span> => text <span class="o">*</span> <span class="n">2</span>
    }
  }

  finalize_plugins!
<span class="k">end</span></code></pre>

<pre><code class="language-crystal">image.metadata[<span class="s">&quot;custom_1&quot;</span>]
image.metadata[<span class="s">&quot;custom_2&quot;</span>]</code></pre>

<h2>Feature Progress</h2>

<p>In no particular order, features that have been implemented and are planned.
Items not marked as completed may have partial implementations.</p>

<ul><li>[X] Shrine</li><li>[X] Shrine::UploadedFile</li><ul><li>[ ] ==</li><li>[X] #original_filename</li><li>[X] #extension</li><li>[X] #size</li><li>[X] #mime_type</li><li>[X] #close</li><li>[X] #url</li><li>[X] #exists?</li><li>[X] #open</li><li>[X] #download</li><li>[X] #stream</li><li>[X] #replace</li><li>[X] #delete</li></ul><li>[ ] Shrine::Attacher</li><li>[ ] Shrine::Attachment</li><li>[ ] Shrine::Storage</li><ul><li>[X] Shrine::Storage::Memory</li><li>[X] Shrine::Storage::FileSystem</li><li>[ ] Shrine::Storage::S3</li></ul><li>[ ] Uploaders</li><ul><li>[X] Custom uploaders</li><li>[ ] Derivatives</li></ul><li>[ ] ORM adapters</li><ul><li>[ ] <code>Granite</code> <a href="https://github.com/amberframework/granite" target="_blank">https://github.com/amberframework/granite</a></li><li>[ ] <code>crecto</code> <a href="https://github.com/Crecto/crecto" target="_blank">https://github.com/Crecto/crecto</a></li><li>[ ] <code>jennifer.cr</code> <a href="https://github.com/imdrasil/jennifer.cr" target="_blank">https://github.com/imdrasil/jennifer.cr</a></li></ul><li>[X] Plugins</li><li>[ ] Background processing</li></ul>

<h2>Contributing</h2>

<ol><li>Fork it (&lt;https://github.com/your-github-user/shrine.cr/fork>)</li><li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li><li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li><li>Push to the branch (<code>git push origin my-new-feature</code>)</li><li>Create a new Pull Request</li></ol>

<h2>Contributors</h2>

<ul><li><a href="https://github.com/igor-alexandrov" target="_blank">Igor Alexandrov</a> - creator and maintainer</li></ul>
</div>
</body>
</html>
